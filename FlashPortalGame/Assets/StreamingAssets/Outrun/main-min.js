function resize_screen(){if(window.innerWidth<100)return;document.getElementById("container").style.transform="scale("+window.innerWidth/640+","+window.innerHeight/480+")"};function update(e){if(!game_paused){var t,n,a,r,o,i=findSegment(position+playerZ),d=SPRITES.PLAYER_STRAIGHT.w*SPRITES.SCALE,s=speed/maxSpeed,l=2*e*s,m=position;if(updateCars(e,i,d),position=Util.increase(position,e*speed,trackLength),keyLeft?playerX-=l:keyRight&&(playerX+=l),playerX-=l*s*i.curve*centrifugal,speed=keyFaster?Util.accelerate(speed,accel,e):keySlower?Util.accelerate(speed,breaking,e):Util.accelerate(speed,decel,e),-1>playerX||playerX>1)for(speed>offRoadLimit&&(speed=Util.accelerate(speed,offRoadDecel,e)),t=0;t<i.sprites.length;t++)if(r=i.sprites[t],o=r.source.w*SPRITES.SCALE,Util.overlap(playerX,d,r.offset+o/2*(r.offset>0?1:-1),o)){speed=maxSpeed/5,position=Util.increase(i.p1.world.z,-playerZ,trackLength);break}for(t=0;t<i.cars.length;t++)if(n=i.cars[t],a=n.sprite.w*SPRITES.SCALE,speed>n.speed&&Util.overlap(playerX,d,n.offset,a,.8)){speed=n.speed*(n.speed/speed),position=Util.increase(n.z,-playerZ,trackLength);break}playerX=Util.limit(playerX,-3,3),speed=Util.limit(speed,0,maxSpeed),skyOffset=Util.increase(skyOffset,skySpeed*i.curve*(position-m)/segmentLength,1),hillOffset=Util.increase(hillOffset,hillSpeed*i.curve*(position-m)/segmentLength,1),treeOffset=Util.increase(treeOffset,treeSpeed*i.curve*(position-m)/segmentLength,1),position>playerZ&&(currentLapTime&&playerZ>m?(lastLapTime=currentLapTime,resetRoad(),lastLapTime<=Util.toFloat(Dom.storage.fast_lap_time)?(Dom.storage.fast_lap_time=lastLapTime,Dom.addClassName("fast_lap_time","fastest"),Dom.addClassName("last_lap_time","fastest")):(Dom.removeClassName("fast_lap_time","fastest"),Dom.removeClassName("last_lap_time","fastest")),Dom.show("last_lap_time")):(currentLapTime+=e,time_limit-=e,0>=time_limit&&game_over(),updateHud("last_lap_time",parseInt(time_limit)))),updateHud("speed",1*Math.round(speed/100)),updateHud("current_lap_time",formatTime(currentLapTime))}}function updateCars(e,t,n){var a,r,o,i;for(a=0;a<cars.length;a++)r=cars[a],o=findSegment(r.z),r.offset=r.offset+updateCarOffset(r,o,t,n),r.z=Util.increase(r.z,e*r.speed,trackLength),r.percent=Util.percentRemaining(r.z,segmentLength),i=findSegment(r.z),o!=i&&(index=o.cars.indexOf(r),o.cars.splice(index,1),i.cars.push(r))}function updateCarOffset(e,t,n,a){var r,o,i,d,s,l,m=20,p=e.sprite.w*SPRITES.SCALE;if(t.index-n.index>drawDistance)return 0;for(r=1;m>r;r++){if(d=segments[(t.index+r)%segments.length],d===n&&e.speed>speed&&Util.overlap(playerX,a,e.offset,p,1.2))return i=playerX>.5?-1:-.5>playerX?1:e.offset>playerX?1:-1,1*i/r*(e.speed-speed)/maxSpeed;for(o=0;o<d.cars.length;o++)if(s=d.cars[o],l=s.sprite.w*SPRITES.SCALE,e.speed>s.speed&&Util.overlap(e.offset,p,s.offset,l,1.2))return i=s.offset>.5?-1:s.offset<-.5?1:e.offset>s.offset?1:-1,1*i/r*(e.speed-s.speed)/maxSpeed}return e.offset<-.9?.1:e.offset>.9?-.1:0}function updateHud(e,t){hud[e].value!==t&&(hud[e].value=t,Dom.set(hud[e].dom,t))}function formatTime(e){var t=parseInt(100*(e-parseInt(e))),n=parseInt(e)%60,a=(parseInt(e)-n)/60;return 0>=n?n="00":10>n&&(n="0"+n),0>=t?t="00":10>t&&(t="0"+t),a+":"+n+":"+t}function render(){var e=findSegment(position),t=Util.percentRemaining(position,segmentLength),n=findSegment(position+playerZ),a=Util.percentRemaining(position+playerZ,segmentLength),r=Util.interpolate(n.p1.world.y,n.p2.world.y,a),o=height,i=0,d=-(e.curve*t);ctx.clearRect(0,0,width,height),Render.background(ctx,background,width,height,BACKGROUND.SKY,skyOffset,resolution*skySpeed*r);var s,l,m,p,c,u,R,f;for(s=0;drawDistance>s;s++)m=segments[(e.index+s)%segments.length],m.looped=m.index<e.index,m.fog=Util.exponentialFog(s/drawDistance,fogDensity),m.clip=o,Util.project(m.p1,playerX*roadWidth-i,r+cameraHeight,position-(m.looped?trackLength:0),cameraDepth,width,height,roadWidth),Util.project(m.p2,playerX*roadWidth-i-d,r+cameraHeight,position-(m.looped?trackLength:0),cameraDepth,width,height,roadWidth),i+=d,d+=m.curve,m.p1.camera.z<=cameraDepth||m.p2.screen.y>=m.p1.screen.y||m.p2.screen.y>=o||(Render.segment(ctx,width,lanes,m.p1.screen.x,m.p1.screen.y,m.p1.screen.w,m.p2.screen.x,m.p2.screen.y,m.p2.screen.w,m.fog,m.color),o=m.p1.screen.y);for(s=drawDistance-1;s>0;s--){for(m=segments[(e.index+s)%segments.length],l=0;l<m.cars.length;l++)p=m.cars[l],c=p.sprite,u=Util.interpolate(m.p1.screen.scale,m.p2.screen.scale,p.percent),R=Util.interpolate(m.p1.screen.x,m.p2.screen.x,p.percent)+u*p.offset*roadWidth*width/2,f=Util.interpolate(m.p1.screen.y,m.p2.screen.y,p.percent),Render.sprite(ctx,width,height,resolution,roadWidth,sprites,p.sprite,u,R,f,-.5,-1,m.clip);for(l=0;l<m.sprites.length;l++)c=m.sprites[l],u=m.p1.screen.scale,R=m.p1.screen.x+u*c.offset*roadWidth*width/2,f=m.p1.screen.y,Render.sprite(ctx,width,height,resolution,roadWidth,sprites,c.source,u,R,f,c.offset<0?-1:0,-1,m.clip);m==n&&Render.player(ctx,width,height,resolution,roadWidth,sprites,speed/maxSpeed,cameraDepth/playerZ,width/2,height/2-cameraDepth/playerZ*Util.interpolate(n.p1.camera.y,n.p2.camera.y,a)*height/2,speed*(keyLeft?-1:keyRight?1:0),n.p2.world.y-n.p1.world.y)}}function findSegment(e){return segments[Math.floor(e/segmentLength)%segments.length]}function lastY(){return 0==segments.length?0:segments[segments.length-1].p2.world.y}function addSegment(e,t){var n=segments.length;segments.push({index:n,p1:{world:{y:lastY(),z:n*segmentLength},camera:{},screen:{}},p2:{world:{y:t,z:(n+1)*segmentLength},camera:{},screen:{}},curve:e,sprites:[],cars:[],color:Math.floor(n/rumbleLength)%2?COLORS.DARK:COLORS.LIGHT})}function addSprite(e,t,n){segments[e].sprites.push({source:t,offset:n})}function addRoad(e,t,n,a,r){var o,i=lastY(),d=i+Util.toInt(r,0)*segmentLength,s=e+t+n;for(o=0;e>o;o++)addSegment(Util.easeIn(0,a,o/e),Util.easeInOut(i,d,o/s));for(o=0;t>o;o++)addSegment(a,Util.easeInOut(i,d,(e+o)/s));for(o=0;n>o;o++)addSegment(Util.easeInOut(a,0,o/n),Util.easeInOut(i,d,(e+t+o)/s))}function addStraight(e){e=e||ROAD.LENGTH.MEDIUM,addRoad(e,e,e,0,0)}function addHill(e,t){e=e||ROAD.LENGTH.MEDIUM,t=t||ROAD.HILL.MEDIUM,addRoad(e,e,e,0,t)}function addCurve(e,t,n){e=e||ROAD.LENGTH.MEDIUM,t=t||ROAD.CURVE.MEDIUM,n=n||ROAD.HILL.NONE,addRoad(e,e,e,t,n)}function addLowRollingHills(e,t){e=e||ROAD.LENGTH.SHORT,t=t||ROAD.HILL.LOW,addRoad(e,e,e,0,t/2),addRoad(e,e,e,0,-t),addRoad(e,e,e,ROAD.CURVE.EASY,t),addRoad(e,e,e,0,0),addRoad(e,e,e,-ROAD.CURVE.EASY,t/2),addRoad(e,e,e,0,0)}function addSCurves(){addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.EASY,ROAD.HILL.NONE),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.CURVE.MEDIUM,ROAD.HILL.MEDIUM),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.CURVE.EASY,-ROAD.HILL.LOW),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.EASY,ROAD.HILL.MEDIUM),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.MEDIUM,-ROAD.HILL.MEDIUM)}function addBumps(){addRoad(10,10,10,0,5),addRoad(10,10,10,0,-2),addRoad(10,10,10,0,-5),addRoad(10,10,10,0,8),addRoad(10,10,10,0,5),addRoad(10,10,10,0,-7),addRoad(10,10,10,0,5),addRoad(10,10,10,0,-2)}function addDownhillToEnd(e){e=e||200,addRoad(e,e,e,-ROAD.CURVE.EASY,-lastY()/segmentLength)}function random(){var e=1e4*Math.sin(seed++);return e-Math.floor(e)}function resetRoad(){level_number++,updateHud("fast_lap_time",level_number),segments=[],seed=level_number,addStraight(ROAD.LENGTH.SHORT);for(var e=0;10+level_number>e;e++){var t=parseInt(13*random());0==t&&addLowRollingHills(),1==t&&addSCurves(),2==t&&addCurve(ROAD.LENGTH.MEDIUM,ROAD.CURVE.MEDIUM,ROAD.HILL.LOW),3==t&&addBumps(),4==t&&addLowRollingHills(),5==t&&addCurve(2*ROAD.LENGTH.LONG,ROAD.CURVE.MEDIUM,ROAD.HILL.MEDIUM),6==t&&addStraight(),7==t&&addHill(ROAD.LENGTH.MEDIUM,ROAD.HILL.HIGH),8==t&&addCurve(ROAD.LENGTH.LONG,-ROAD.CURVE.MEDIUM,ROAD.HILL.NONE),9==t&&addHill(ROAD.LENGTH.LONG,ROAD.HILL.HIGH),10==t&&addCurve(ROAD.LENGTH.LONG,ROAD.CURVE.MEDIUM,-ROAD.HILL.LOW),11==t&&addHill(ROAD.LENGTH.LONG,-ROAD.HILL.MEDIUM),12==t&&addStraight()}addDownhillToEnd(),time_limit_max=85+5*level_number,time_limit=time_limit_max,1==level_number&&(totalCars=100,resetCars()),resetSprites(),segments[findSegment(playerZ).index+2].color=COLORS.START,segments[findSegment(playerZ).index+3].color=COLORS.START;for(var n=0;rumbleLength>n;n++)segments[segments.length-1-n].color=COLORS.FINISH;trackLength=segments.length*segmentLength}function resetSprites(){var e,t;for(addSprite(20,SPRITES.BILLBOARD07,-1),addSprite(40,SPRITES.BILLBOARD06,-1),addSprite(60,SPRITES.BILLBOARD08,-1),addSprite(80,SPRITES.BILLBOARD09,-1),addSprite(100,SPRITES.BILLBOARD01,-1),addSprite(120,SPRITES.BILLBOARD02,-1),addSprite(140,SPRITES.BILLBOARD03,-1),addSprite(160,SPRITES.BILLBOARD04,-1),addSprite(180,SPRITES.BILLBOARD05,-1),addSprite(240,SPRITES.BILLBOARD07,-1.2),addSprite(240,SPRITES.BILLBOARD06,1.2),addSprite(segments.length-25,SPRITES.BILLBOARD07,-1.2),addSprite(segments.length-25,SPRITES.BILLBOARD06,1.2),e=10;200>e;e+=4+Math.floor(e/100))addSprite(e,SPRITES.PALM_TREE,.5+.5*Math.random()),addSprite(e,SPRITES.PALM_TREE,1+2*Math.random());for(e=250;1e3>e;e+=5)addSprite(e,SPRITES.COLUMN,1.1),addSprite(e+Util.randomInt(0,5),SPRITES.TREE1,-1-2*Math.random()),addSprite(e+Util.randomInt(0,5),SPRITES.TREE2,-1-2*Math.random());for(e=200;e<segments.length;e+=3)addSprite(e,Util.randomChoice(SPRITES.PLANTS),Util.randomChoice([1,-1])*(2+5*Math.random()));var n,a,r;for(e=1e3;e<segments.length-50;e+=100)for(n=Util.randomChoice([1,-1]),addSprite(e+Util.randomInt(0,50),Util.randomChoice(SPRITES.BILLBOARDS),-n),t=0;20>t;t++)a=Util.randomChoice(SPRITES.PLANTS),r=n*(1.5+Math.random()),addSprite(e+Util.randomInt(0,50),a,r)}function resetCars(){cars=[];for(var e,t,n,a,r,o,i,e=0;totalCars>e;e++)a=Math.random()*Util.randomChoice([-.8,.8]),r=Math.floor(Math.random()*segments.length)*segmentLength,o=Util.randomChoice(SPRITES.CARS),i=maxSpeed/4+Math.random()*maxSpeed/(o==SPRITES.SEMI?4:2),t={offset:a,z:r,sprite:o,speed:i},n=findSegment(t.z),n.cars.push(t),cars.push(t)}function reset(e){e=e||{},canvas.width=width=Util.toInt(e.width,width),canvas.height=height=Util.toInt(e.height,height),lanes=Util.toInt(e.lanes,lanes),roadWidth=Util.toInt(e.roadWidth,roadWidth),cameraHeight=Util.toInt(e.cameraHeight,cameraHeight),drawDistance=Util.toInt(e.drawDistance,drawDistance),fogDensity=Util.toInt(e.fogDensity,fogDensity),fieldOfView=Util.toInt(e.fieldOfView,fieldOfView),segmentLength=Util.toInt(e.segmentLength,segmentLength),rumbleLength=Util.toInt(e.rumbleLength,rumbleLength),cameraDepth=1/Math.tan(fieldOfView/2*Math.PI/180),playerZ=cameraHeight*cameraDepth,resolution=height/480,(0==segments.length||e.segmentLength||e.rumbleLength)&&resetRoad()}function move_start(e){"left"==e&&(keyLeft=!0),"right"==e&&(keyRight=!0),"up"==e&&(keyFaster=!0),"down"==e&&(keySlower=!0)}function move_stop(e){"left"==e&&(keyLeft=!1),"right"==e&&(keyRight=!1),"up"==e&&(keyFaster=!1),"down"==e&&(keySlower=!1)}function start_game(){game_paused&&(document.getElementById("footer_div").style.display="none",document.getElementById("speed").innerHTML='<span id="speed_value" class="value">0</span> kph',level_number=0,position=0,startPosition=position,time_limit=90,currentLapTime=0,hud={speed:{value:null,dom:Dom.get("speed_value")},current_lap_time:{value:null,dom:Dom.get("current_lap_time_value")},last_lap_time:{value:null,dom:Dom.get("last_lap_time_value")},fast_lap_time:{value:null,dom:Dom.get("fast_lap_time_value")}},updateHud("last_lap_time",parseInt(time_limit)),updateHud("fast_lap_time","1"),resetRoad(),Game.playMusic(),game_paused=!1,just_started=!0,document.getElementById("frontpage").style.display="none",document.getElementById("game_over_div").style.display="none")}function game_over(){game_paused=!0,speed=0,document.getElementById("footer_div").style.display="block",document.getElementById("game_over_div").style.display="block"}function leftClick(e){return window.focus(),e||(e=event),"undefined"==typeof e.which?1==e.button:1==e.which||0==e.button}function nrc(e){return 0==leftClick(e)?ce(e):void 0}function cp(e){e||(e=event),e.stopPropagation?e.stopPropagation():"undefined"!=typeof e.cancelBubble&&(e.cancelBubble=!0)}function ce(e){return e||(e=event),"undefined"!=typeof e.preventDefault?e.preventDefault():"undefined"!=typeof e.cancelBubble&&(e.returnValue=0,e.cancelBubble=!0),!1}var Dom={get:function(e){return e instanceof HTMLElement||e===document?e:document.getElementById(e)},set:function(e,t){Dom.get(e).innerHTML=t},on:function(e,t,n,a){Dom.get(e).addEventListener(t,n,a)},un:function(e,t,n,a){Dom.get(e).removeEventListener(t,n,a)},show:function(e,t){Dom.get(e).style.display=t||"block"},blur:function(e){e.target.blur()},addClassName:function(e,t){Dom.toggleClassName(e,t,!0)},removeClassName:function(e,t){Dom.toggleClassName(e,t,!1)},toggleClassName:function(e,t,n){e=Dom.get(e);var a=e.className.split(" "),r=a.indexOf(t);n="undefined"==typeof n?0>r:n,n&&0>r?a.push(t):!n&&r>=0&&a.splice(r,1),e.className=a.join(" ")},storage:{}},Util={timestamp:function(){return(new Date).getTime()},toInt:function(e,t){if(null!==e){var n=parseInt(e,10);if(!isNaN(n))return n}return Util.toInt(t,0)},toFloat:function(e,t){if(null!==e){var n=parseFloat(e);if(!isNaN(n))return n}return Util.toFloat(t,0)},limit:function(e,t,n){return Math.max(t,Math.min(e,n))},randomInt:function(e,t){return Math.round(Util.interpolate(e,t,Math.random()))},randomChoice:function(e){return e[Util.randomInt(0,e.length-1)]},percentRemaining:function(e,t){return e%t/t},accelerate:function(e,t,n){return e+t*n},interpolate:function(e,t,n){return e+(t-e)*n},easeIn:function(e,t,n){return e+(t-e)*Math.pow(n,2)},easeOut:function(e,t,n){return e+(t-e)*(1-Math.pow(1-n,2))},easeInOut:function(e,t,n){return e+(t-e)*(-Math.cos(n*Math.PI)/2+.5)},exponentialFog:function(e,t){return 1/Math.pow(Math.E,e*e*t)},increase:function(e,t,n){for(var a=e+t;a>=n;)a-=n;for(;0>a;)a+=n;return a},project:function(e,t,n,a,r,o,i,d){e.camera.x=(e.world.x||0)-t,e.camera.y=(e.world.y||0)-n,e.camera.z=(e.world.z||0)-a,e.screen.scale=r/e.camera.z,e.screen.x=Math.round(o/2+e.screen.scale*e.camera.x*o/2),e.screen.y=Math.round(i/2-e.screen.scale*e.camera.y*i/2),e.screen.w=Math.round(e.screen.scale*d*o/2)},overlap:function(e,t,n,a,r){var o=(r||1)/2,i=e-t*o,d=e+t*o,s=n-a*o,l=n+a*o;return!(s>d||i>l)}};window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)});var Game={run:function(e){Game.loadImages(e.images,function(t){function n(){for(d=Util.timestamp(),l=Math.min(1,(d-s)/1e3),m+=l;m>i;)m-=i,r(i);o(),s=d,requestAnimationFrame(n,a)}e.ready(t),Game.setKeyListener(e.keys);var a=e.canvas,r=e.update,o=e.render,i=e.step,d=(e.stats,null),s=Util.timestamp(),l=0,m=0;n()})},loadImages:function(e,t){for(var n=[],a=e.length,r=function(){0==--a&&t(n)},o=0;o<e.length;o++){var i=e[o];n[o]=document.createElement("img"),Dom.on(n[o],"load",r),n[o].src="images/"+i+".png"}},setKeyListener:function(e){var t=function(t,n){var a,r;for(a=0;a<e.length;a++)r=e[a],r.mode=r.mode||"up",(r.key==t||r.keys&&r.keys.indexOf(t)>=0)&&r.mode==n&&r.action.call()};Dom.on(document,"keydown",function(e){t(e.keyCode,"down"),e.preventDefault()}),Dom.on(document,"keyup",function(e){t(e.keyCode,"up"),e.preventDefault()})},stats:function(e,t){var n=new Stats;n.domElement.id=t||"stats",Dom.get(e).appendChild(n.domElement);var a=document.createElement("div");a.style.cssText="border: 2px solid gray; padding: 5px; margin-top: 5px; text-align: left; font-size: 1.15em; text-align: right;",a.innerHTML="Your canvas performance is ",Dom.get(e).appendChild(a);var r=document.createElement("span");return r.innerHTML="...",a.appendChild(r),setInterval(function(){var e=n.current(),t=e>50?"good":30>e?"bad":"ok",o=e>50?"green":30>e?"red":"gray";r.innerHTML=t,r.style.color=o,a.style.borderColor=o},5e3),n},playMusic:function(){var e=Dom.get("music");e.loop=!0,e.volume=.5,e.muted="true"===Dom.storage.muted,e.play(),Dom.toggleClassName("mute","on",e.muted),Dom.on("mute","click",function(){Dom.storage.muted=e.muted=!e.muted,Dom.toggleClassName("mute","on",e.muted)})}},Render={polygon:function(e,t,n,a,r,o,i,d,s,l){e.fillStyle=l,e.beginPath(),e.moveTo(t,n),e.lineTo(a,r),e.lineTo(o,i),e.lineTo(d,s),e.closePath(),e.fill()},segment:function(e,t,n,a,r,o,i,d,s,l,m){var p,c,u,R,f,S=Render.rumbleWidth(o,n),E=Render.rumbleWidth(s,n),g=Render.laneMarkerWidth(o,n),h=Render.laneMarkerWidth(s,n);if(e.fillStyle=m.grass,e.fillRect(0,d,t,r-d),Render.polygon(e,a-o-S,r,a-o,r,i-s,d,i-s-E,d,m.rumble),Render.polygon(e,a+o+S,r,a+o,r,i+s,d,i+s+E,d,m.rumble),Render.polygon(e,a-o,r,a+o,r,i+s,d,i-s,d,m.road),m.lane)for(p=2*o/n,c=2*s/n,u=a-o+p,R=i-s+c,f=1;n>f;u+=p,R+=c,f++)Render.polygon(e,u-g/2,r,u+g/2,r,R+h/2,d,R-h/2,d,m.lane)},background:function(e,t,n,a,r,o,i){o=o||0,i=i||0;var d=r.w/2,s=r.h,l=r.x+Math.floor(r.w*o),m=r.y,p=Math.min(d,r.x+r.w-l),c=s,u=0,R=i,f=Math.floor(n*(p/d)),S=a;e.drawImage(t,l,m,p,c,u,R,f,S),d>p&&e.drawImage(t,r.x,m,d-p,c,f-1,R,n-f,S)},sprite:function(e,t,n,a,r,o,i,d,s,l,m,p,c){var u=i.w*d*t/2*SPRITES.SCALE*r,R=i.h*d*t/2*SPRITES.SCALE*r;s+=u*(m||0),l+=R*(p||0);var f=c?Math.max(0,l+R-c):0;R>f&&(s>300&&i.flip?e.drawImage(o,i.x,i.y+580,i.w,i.h-i.h*f/R,s,l,u,R-f):e.drawImage(o,i.x,i.y,i.w,i.h-i.h*f/R,s,l,u,R-f))},player:function(e,t,n,a,r,o,i,d,s,l,m,p){var c,u=1.5*Math.random()*i*a*Util.randomChoice([-1,1]);c=0>m?p>0?SPRITES.PLAYER_UPHILL_LEFT:SPRITES.PLAYER_LEFT:m>0?p>0?SPRITES.PLAYER_UPHILL_RIGHT:SPRITES.PLAYER_RIGHT:p>0?SPRITES.PLAYER_UPHILL_STRAIGHT:SPRITES.PLAYER_STRAIGHT,Render.sprite(e,t,n,a,r,o,c,d,s,l+u,-.5,-1)},fog:function(e,t,n,a,r,o){1>o&&(e.globalAlpha=1-o,e.fillStyle=COLORS.FOG,e.fillRect(t,n,a,r),e.globalAlpha=1)},rumbleWidth:function(e,t){return e/Math.max(6,2*t)},laneMarkerWidth:function(e,t){return e/Math.max(32,8*t)}},KEY={LEFT:37,UP:38,RIGHT:39,DOWN:40,A:65,D:68,S:83,W:87},COLORS={SKY:"#72D7EE",TREE:"#005108",FOG:"#005108",LIGHT:{road:"#6B6B6B",grass:"#10AA10",rumble:"#555555",lane:"#CCCCCC"},DARK:{road:"#696969",grass:"#009A00",rumble:"#BBBBBB"},START:{road:"white",grass:"white",rumble:"white"},FINISH:{road:"black",grass:"black",rumble:"black"}},BACKGROUND={HILLS:{x:5,y:5,w:1280,h:480},SKY:{x:5,y:495,w:1280,h:480},TREES:{x:5,y:985,w:1280,h:480}},SPRITES={PALM_TREE:{x:5,y:5,w:215,h:540},BILLBOARD08:{x:313,y:897,w:298,h:190},TREE1:{x:625,y:5,w:360,h:360},DEAD_TREE1:{x:5,y:555,w:135,h:332},BILLBOARD09:{x:625,y:375,w:300,h:170},BOULDER3:{x:230,y:280,w:320,h:220},COLUMN:{x:995,y:5,w:200,h:315},BILLBOARD01:{x:625,y:375,w:300,h:170},BILLBOARD06:{x:488,y:555,w:298,h:190},BILLBOARD05:{x:5,y:897,w:298,h:190},BILLBOARD07:{x:313,y:897,w:298,h:190},BOULDER2:{x:621,y:897,w:298,h:140},TREE2:{x:1205,y:5,w:282,h:295},BILLBOARD04:{x:1205,y:310,w:268,h:170},DEAD_TREE2:{x:1205,y:490,w:150,h:260},BOULDER1:{x:1205,y:760,w:168,h:248},BUSH1:{x:5,y:1097,w:240,h:155},CACTUS:{x:929,y:897,w:235,h:118},BUSH2:{x:255,y:1097,w:232,h:152},BILLBOARD03:{x:5,y:1262,w:230,h:220},BILLBOARD02:{x:245,y:1262,w:215,h:220},STUMP:{x:995,y:330,w:195,h:140},SEMI:{x:1365,y:490,w:122,h:144,flip:!0},TRUCK:{x:1365,y:644,w:100,h:78,flip:!0},CAR03:{x:1383,y:760,w:88,h:55,flip:!0},CAR02:{x:1383,y:825,w:80,h:59,flip:!0},CAR04:{x:1383,y:894,w:80,h:57,flip:!0},CAR01:{x:1205,y:1018,w:80,h:56,flip:!0},PLAYER_UPHILL_LEFT:{x:1383,y:961,w:80,h:45},PLAYER_UPHILL_STRAIGHT:{x:1295,y:1018,w:80,h:45},PLAYER_UPHILL_RIGHT:{x:1385,y:1018,w:80,h:45},PLAYER_LEFT:{x:995,y:480,w:80,h:41},PLAYER_STRAIGHT:{x:1085,y:480,w:80,h:41},PLAYER_RIGHT:{x:995,y:531,w:80,h:41}};SPRITES.SCALE=.3*(1/SPRITES.PLAYER_STRAIGHT.w),SPRITES.BILLBOARDS=[SPRITES.BILLBOARD01,SPRITES.BILLBOARD02,SPRITES.BILLBOARD03,SPRITES.BILLBOARD04,SPRITES.BILLBOARD05,SPRITES.BILLBOARD06,SPRITES.BILLBOARD07,SPRITES.BILLBOARD08,SPRITES.BILLBOARD09],SPRITES.PLANTS=[SPRITES.TREE1,SPRITES.TREE2,SPRITES.DEAD_TREE1,SPRITES.DEAD_TREE2,SPRITES.PALM_TREE,SPRITES.BUSH1,SPRITES.BUSH2,SPRITES.CACTUS,SPRITES.STUMP,SPRITES.BOULDER1,SPRITES.BOULDER2,SPRITES.BOULDER3],SPRITES.CARS=[SPRITES.CAR01,SPRITES.CAR02,SPRITES.CAR03,SPRITES.CAR04,SPRITES.SEMI,SPRITES.TRUCK];var fps=60,step=1/fps,width=640,height=480,centrifugal=.3,offRoadDecel=.99,skySpeed=.001,hillSpeed=.002,treeSpeed=.003,skyOffset=0,hillOffset=0,treeOffset=0,segments=[],cars=[],stats=!1,canvas=Dom.get("canvas"),ctx=canvas.getContext("2d"),background=null,sprites=null,resolution=null,roadWidth=2e3,segmentLength=200,rumbleLength=3,trackLength=null,lanes=3,fieldOfView=100,cameraHeight=1e3,cameraDepth=null,drawDistance=300,playerX=0,playerZ=null,fogDensity=5,position=0,speed=0,maxSpeed=segmentLength/step,accel=maxSpeed/5,breaking=-maxSpeed,decel=-maxSpeed/5,offRoadDecel=-maxSpeed/2,offRoadLimit=maxSpeed/4,totalCars=200,currentLapTime=0,lastLapTime=null,game_paused=!0,keyLeft=!1,keyRight=!1,keyFaster=!1,keySlower=!1,hud={speed:{value:null,dom:Dom.get("speed_value")},current_lap_time:{value:null,dom:Dom.get("current_lap_time_value")},last_lap_time:{value:null,dom:Dom.get("last_lap_time_value")},fast_lap_time:{value:null,dom:Dom.get("fast_lap_time_value")}},ROAD={LENGTH:{NONE:0,SHORT:25,MEDIUM:50,LONG:100},HILL:{NONE:0,LOW:20,MEDIUM:40,HIGH:60},CURVE:{NONE:0,EASY:2,MEDIUM:4,HARD:6}},seed=1,level_number=0,time_limit=90,just_started=!0;Game.run({canvas:canvas,render:render,update:update,stats:stats,step:step,images:["background","sprites"],keys:[{keys:[KEY.LEFT,KEY.A],mode:"down",action:function(){keyLeft=!0}},{keys:[KEY.RIGHT,KEY.D],mode:"down",action:function(){keyRight=!0}},{keys:[KEY.UP,KEY.W],mode:"down",action:function(){keyFaster=!0}},{keys:[KEY.DOWN,KEY.S],mode:"down",action:function(){keySlower=!0}},{keys:[KEY.LEFT,KEY.A],mode:"up",action:function(){keyLeft=!1}},{keys:[KEY.RIGHT,KEY.D],mode:"up",action:function(){keyRight=!1}},{keys:[KEY.UP,KEY.W],mode:"up",action:function(){keyFaster=!1}},{keys:[KEY.DOWN,KEY.S],mode:"up",action:function(){keySlower=!1}},{keys:[32],mode:"up",action:function(){start_game()}}],ready:function(e){resize_screen();window.onresize=resize_screen;background=e[0],sprites=e[1],reset(),Dom.storage.fast_lap_time=Dom.storage.fast_lap_time||180,document.getElementById("dpad").style.display="block",document.getElementById("loading_message").innerHTML="USE ARROW KEYS ON KEYBOARD<br>OR ON-SCREEN CONTOLS ON MOBILE<br>TOUCH SCREEN OR PRESS SPACE TO START",window.focus()}}),"undefined"!=typeof document.oncontextmenu?document.oncontextmenu=ce:document.onclick=nrc,"undefined"!=typeof document.onselectstart&&(document.onselectstart=ce),"undefined"!=typeof document.ondragstart&&(document.ondragstart=ce);